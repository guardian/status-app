@(stage: String, estate: model.Estate, totalSunkCost: Float, money: java.text.DecimalFormat)(implicit request: play.api.mvc.Security.AuthenticatedRequest[_, User])

@import model._

@main("Status Monitor", refreshSecs = Some(15)) {

    <nav class="navbar navbar-default navbar-static-top tight-bottom">
        <ul class="nav navbar-nav">
        @for(s <- estate.stages) {
            <li class="@if(stage == s) {active}"><a href="/@s">@s</a></li>
        }
        </ul>
        <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
                <a data-toggle="dropdown" href="#" class="dropdown-toggle">
                    <i class="glyphicon glyphicon-user"></i> @request.user.fullName
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu">
                    <li><a href="@routes.Login.logout()">Sign Out</a></li>
                </ul>
            </li>
        </ul>
    </nav>
    <div class="container cluster-status">
        <div class="row">

        @for(column <- estate(stage).grouped(math.max(estate(stage).size / 3, 1))) {

            <div class="col-lg-4">
            @for(cluster <- column) {
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="pull-right">~ $@money.format(cluster.approxMonthlyCost)/month</div>
                        <h4 class="panel-title">@cluster.appName</h4>
                    </div>

                    @if(!cluster.suspendedActivities.isEmpty) {
                    <div class="alert alert-warning panel-body">
                       <strong>Warning!</strong> The following autoscaling activities are currently
                       suspended: @cluster.suspendedActivities.mkString(", ")
                    </div>
                    }

                    <table class="table table-condensed">

                        <thead>
                            <th>Instance</th>
                            <th>AutoScaling</th>
                            @if(cluster.hasElb) {
                                <th>ELB</th>
                            }
                            <th>Uptime</th>
                            <th>Version</th>
                        </thead>

                    @for(member <- cluster.members) {
                      <tr class="@member.goodorbad">
                      <td><a href="@routes.Application.instance(member.id)">@member.id</a></td>
                      <td>@member.lifecycleState</td>
                      @if(cluster.hasElb) {
                      <td title="@member.description">@member.state<br>@member.description</td>
                      }
                      <td>@member.instance.uptime</td>
                      <td>@member.instance.version.getOrElse("?")</td>
                      </tr>
                    }

                    </table>

                    @if(!cluster.recentActivity.isEmpty) {
                    <div id="@cluster.name-activity" class="accordion panel-footer">
                        <div class="accordion-group">
                            <div class="accordion-heading">
                                <a class="accordion-toggle" data-toggle="collapse" data-parent="#@cluster.name-activity" href="#@cluster.name-activity-details">
                                    <small>Recent activity</small>
                                </a>
                            </div>
                            <div id="@cluster.name-activity-details" class="accordion-body collapse">
                                <div class="accordion-inner">
                                    <small>
                                    @for(action <- cluster.recentActivity.take(3)) {
                                        <p><strong>@action.age</strong> @action.cause</p>
                                    }
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                </div>
            }
            </div>
        }
        </div>
        <div class="row">
            <div class="well">
                Approximate total monthly cost for all stages: $@money.format(estate(stage).map(_.approxMonthlyCost).sum)
                @if(totalSunkCost > 0) { (total sunk cost: $@money.format(totalSunkCost)) }
            </div>
        </div>
    </div>
}